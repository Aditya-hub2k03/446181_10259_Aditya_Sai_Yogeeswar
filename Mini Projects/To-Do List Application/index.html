<!DOCTYPE html>
<html>
  <head>
    <title>To Do List Application</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
      .blurred-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        background-image: url("https://images.unsplash.com/photo-1484480974693-6ca0a78fb36b?fm=jpg&q=60&w=3000&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8dG8lMjBkbyUyMGxpc3R8ZW58MHx8MHx8fDA%3D");
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        filter: blur(6px);
      }
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        position: relative;
        overflow-x: hidden;
      }
      form,
      .content,
      table,
      h1,
      h2 {
        position: relative;
        z-index: 1;
      }
      .sort-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        padding: 0 5px;
      }
      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        border: 3px solid black;
        width: 450px;
        text-align: center;
        font-family: Arial, sans-serif;
      }
      .modal-buttons {
        margin: 20px 0;
      }
      .modal-button {
        padding: 8px 20px;
        margin: 0 10px;
        border: 2px solid black;
        background-color: white;
        cursor: pointer;
        font-size: 14px;
      }
      .modal-button:hover {
        background-color: #f0f0f0;
      }
      .status-section {
        margin-top: 20px;
        text-align: left;
        padding-left: 50px;
      }
      .status-options {
        margin-top: 10px;
      }
      .status-option {
        margin: 10px 0;
        display: flex;
        align-items: center;
      }
      .status-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid black;
        margin-right: 10px;
        cursor: pointer;
      }
      .status-checkbox:disabled {
        cursor: not-allowed;
        opacity: 0.5;
      }
      .status-label {
        font-size: 14px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="blurred-bg"></div>
    <!-- Past Date Confirmation Modal -->
    <div id="pastDateModal" class="modal">
      <div class="modal-content">
        <h3>Confirm to add a task on a past date</h3>
        <div class="modal-buttons">
          <button class="modal-button" id="confirmYes">Yes</button>
          <button class="modal-button" id="confirmNo">No</button>
        </div>
        <div class="status-section">
          <p>
            <strong>Select the status to of the task for the past date</strong>
          </p>
          <div class="status-options">
            <div class="status-option">
              <input
                type="checkbox"
                class="status-checkbox"
                id="pendingStatus"
                disabled
              />
              <label class="status-label">PENDING</label>
            </div>
            <div class="status-option">
              <input
                type="checkbox"
                class="status-checkbox"
                id="inProgressStatus"
                disabled
              />
              <label class="status-label">IN PROGRESS</label>
            </div>
            <div class="status-option">
              <input
                type="checkbox"
                class="status-checkbox"
                id="completedStatus"
                disabled
              />
              <label class="status-label">COMPLETED</label>
            </div>
          </div>
        </div>
      </div>
    </div>
    <h1 style="text-align: center">Add a To Do Item</h1>
    <form id="todoForm" onsubmit="return false;">
      <table border="0" style="margin-left: auto; margin-right: auto">
        <tr>
          <td><label for="todayDate">Today's Date:</label></td>
          <td>
            <input
              type="date"
              id="todayDate"
              name="todayDate"
              required
              readonly
              style="background: 0; border: 0px; color: green"
            />
          </td>
        </tr>
        <tr>
          <td><label for="todoDescription">To Do Description:</label></td>
          <td>
            <input
              type="text"
              id="todoDescription"
              name="todoDescription"
              required
            />
          </td>
        </tr>
        <tr>
          <td><label for="targetDateTime">Target Date & Time:</label></td>
          <td>
            <input
              type="text"
              id="targetDateTime"
              placeholder="Select target Date and time"
              name="targetDateTime"
              required
            />
          </td>
        </tr>
        <tr>
          <td><label for="status">Status:</label></td>
          <td>
            <input
              type="text"
              id="status"
              name="status"
              value="Pending"
              disabled
              style="
                border: 0px;
                background-color: 0;
                font-size: 90%;
                font-weight: bold;
              "
            />
          </td>
        </tr>
        <tr>
          <td colspan="2" align="center">
            <input
              type="button"
              id="addButton"
              value="Add To Do"
              onclick="addToDo()"
            />
            <input
              type="button"
              id="updateButton"
              value="Update"
              onclick="updateToDo()"
              style="display: none"
            />
            <input
              type="button"
              value="Cancel"
              id="cancelButton"
              onclick="cancelEdit()"
              style="display: none"
            />
          </td>
        </tr>
      </table>
    </form>
    <br />
    <!-- Global Search Bar -->
    <div
      style="
        margin-bottom: 20px;
        text-align: center;
        border: 2px solid #000;
        padding: 20px;
        background-color: #d2bfb2;
        margin-left: auto;
        margin-right: auto;
        width: 650px;
      "
    >
      <div style="margin-bottom: 10px">
        <input
          type="text"
          id="globalSearchKeyword"
          placeholder="Search by keyword..."
          style="
            width: 300px;
            padding: 8px;
            border: 1px solid #ccc;
            margin-right: 10px;
          "
        />
        <button
          onclick="globalSearch()"
          style="padding: 8px 15px; cursor: pointer"
        >
          üîç
        </button>
        <button
          onclick="resetGlobalFilters()"
          style="padding: 8px 15px; cursor: pointer; margin-left: 5px"
        >
          Reset
        </button>
      </div>
      <div>
        Start Date:
        <input
          type="text"
          id="globalStartDate"
          placeholder="Select Start Date and time"
          style="
            width: 160px;
            padding: 5px;
            margin-right: 15px;
            margin-left: 5px;
          "
        />
        End Date:
        <input
          type="text"
          id="globalEndDate"
          placeholder="Select End Date and time"
          style="width: 160px; padding: 5px; margin-left: 5px"
        />
      </div>
    </div>
    <h2 style="text-align: center">To Do List</h2>
    <br />
    <table
      border="2"
      id="todoTable"
      style="width: 100%; border-collapse: collapse; border-color: #000000"
    >
      <thead>
        <tr>
          <th style="width: 250px">
            Todo ID
            <button class="sort-btn" onclick="sortById()">‚Üë‚Üì</button>
          </th>
          <th style="width: 370px">ToDo Description</th>
          <th style="width: 350px">
            Target Date & Time
            <button class="sort-btn" onclick="sortByDateTime()">‚Üë‚Üì</button>
          </th>
          <th style="width: 320px">
            Current Status
            <button class="sort-btn" onclick="sortByStatus()">‚Üë‚Üì</button>
          </th>
          <th>Status Action</th>
          <th>Edit</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <script>
      var todoCounter = 0;
      var todos = [];
      var editingTodoId = null;
      var pendingPastDateTask = null;
      var sortConfig = {
        id: { ascending: true },
        dateTime: { ascending: true },
        status: { order: ["In progress", "Pending", "completed"] },
      };

      function initializeForm() {
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = String(today.getMonth() + 1).padStart(2, "0");
        var dd = String(today.getDate()).padStart(2, "0");
        var formattedDate = yyyy + "-" + mm + "-" + dd;
        document.getElementById("todayDate").value = formattedDate;
        document.getElementById("status").value = "Pending";
      }

      window.onload = function () {
        initializeForm();
        setupModalEvents();
      };

      function setupModalEvents() {
        const modal = document.getElementById("pastDateModal");
        const yesBtn = document.getElementById("confirmYes");
        const noBtn = document.getElementById("confirmNo");
        const statusCheckboxes = [
          "pendingStatus",
          "inProgressStatus",
          "completedStatus",
        ];

        yesBtn.addEventListener("click", function () {
          statusCheckboxes.forEach((id) => {
            document.getElementById(id).disabled = false;
          });
        });

        noBtn.addEventListener("click", function () {
          modal.style.display = "none";
          pendingPastDateTask = null;
          resetStatusCheckboxes();
        });

        statusCheckboxes.forEach((id) => {
          document.getElementById(id).addEventListener("change", function () {
            if (this.checked) {
              statusCheckboxes.forEach((otherId) => {
                if (otherId !== id) {
                  document.getElementById(otherId).checked = false;
                }
              });

              let selectedStatus = "";
              if (id === "pendingStatus") selectedStatus = "Pending";
              else if (id === "inProgressStatus")
                selectedStatus = "In progress";
              else if (id === "completedStatus") selectedStatus = "completed";

              addPastDateTask(selectedStatus);
              modal.style.display = "none";
              resetStatusCheckboxes();
            }
          });
        });
      }

      function resetStatusCheckboxes() {
        const statusCheckboxes = [
          "pendingStatus",
          "inProgressStatus",
          "completedStatus",
        ];
        statusCheckboxes.forEach((id) => {
          const checkbox = document.getElementById(id);
          checkbox.checked = false;
          checkbox.disabled = true;
        });
      }

      function getNextToDoID() {
        todoCounter += 1;
        return todoCounter;
      }

      function formatDateTimeDisplay(dateTime) {
        var parts = dateTime.split("T");
        if (parts.length < 2) return dateTime;
        var datePart = parts[0],
          timePart = parts[1];
        var dparts = datePart.split("-");
        var year = dparts[0],
          month = dparts[1],
          day = dparts[2];
        var tparts = timePart.split(":");
        var hour = tparts[0],
          min = tparts[1];
        return day + ":" + month + ":" + year + " " + hour + ":" + min;
      }

      function formatEditedDateDisplay(dateObj) {
        var hh = String(dateObj.getHours()).padStart(2, "0");
        var mm = String(dateObj.getMinutes()).padStart(2, "0");
        var dd = String(dateObj.getDate()).padStart(2, "0");
        var MM = String(dateObj.getMonth() + 1).padStart(2, "0");
        var yyyy = dateObj.getFullYear();
        return hh + ":" + mm + " " + dd + "-" + MM + "-" + yyyy;
      }

      function sortById() {
        sortConfig.id.ascending = !sortConfig.id.ascending;
        sortTodos();
        renderTable();
      }

      function sortByDateTime() {
        sortConfig.dateTime.ascending = !sortConfig.dateTime.ascending;
        sortTodos();
        renderTable();
      }

      function sortByStatus() {
        const currentOrder = sortConfig.status.order;
        if (
          currentOrder[0] === "In progress" &&
          currentOrder[1] === "Pending"
        ) {
          sortConfig.status.order = ["Pending", "completed", "In progress"];
        } else if (
          currentOrder[0] === "Pending" &&
          currentOrder[1] === "completed"
        ) {
          sortConfig.status.order = ["completed", "In progress", "Pending"];
        } else {
          sortConfig.status.order = ["In progress", "Pending", "completed"];
        }
        sortTodos();
        renderTable();
      }

      function sortTodos() {
        if (sortConfig.id.ascending) {
          todos.sort((a, b) => a.id - b.id);
        } else {
          todos.sort((a, b) => b.id - a.id);
        }

        if (sortConfig.dateTime.ascending) {
          todos.sort(
            (a, b) => new Date(a.targetDateTime) - new Date(b.targetDateTime)
          );
        } else {
          todos.sort(
            (a, b) => new Date(b.targetDateTime) - new Date(a.targetDateTime)
          );
        }

        const statusOrder = sortConfig.status.order;
        todos.sort((a, b) => {
          const statusA = a.status.startsWith("In progress")
            ? "In progress"
            : a.status.startsWith("completed")
            ? "completed"
            : "Pending";
          const statusB = b.status.startsWith("In progress")
            ? "In progress"
            : b.status.startsWith("completed")
            ? "completed"
            : "Pending";
          return statusOrder.indexOf(statusA) - statusOrder.indexOf(statusB);
        });
      }

      function addToDo() {
        var description = document
          .getElementById("todoDescription")
          .value.trim();
        var dateTime = document.getElementById("targetDateTime").value;
        var addedDate = document.getElementById("todayDate").value;

        if (!description || !dateTime) {
          alert("Please enter all required fields.");
          return;
        }

        var nowISO = new Date().toISOString().slice(0, 16);
        if (dateTime < nowISO) {
          pendingPastDateTask = {
            description: description,
            addedDate: addedDate,
            targetDateTime: dateTime,
          };
          document.getElementById("pastDateModal").style.display = "block";
          return;
        }

        var newId = getNextToDoID();
        var todo = {
          id: newId,
          description: description,
          addedDate: addedDate,
          editedDate: null,
          targetDateTime: dateTime,
          status: "Pending",
        };
        todos.push(todo);
        sortTodos();
        renderTable();
        resetForm();
      }

      function addPastDateTask(selectedStatus) {
        if (!pendingPastDateTask) return;

        var newId = getNextToDoID();
        var todo = {
          id: newId,
          description: pendingPastDateTask.description,
          addedDate: pendingPastDateTask.addedDate,
          editedDate: null,
          targetDateTime: pendingPastDateTask.targetDateTime,
          status: selectedStatus,
        };
        todos.push(todo);
        sortTodos();
        renderTable();
        resetForm();
        pendingPastDateTask = null;
      }

      function renderTable() {
        var tbody = document
          .getElementById("todoTable")
          .getElementsByTagName("tbody")[0];
        tbody.innerHTML = "";
        todos.forEach(function (todo) {
          var row = tbody.insertRow();

          var cellId = row.insertCell(0);
          cellId.innerText = todo.id;

          var cellDesc = row.insertCell(1);
          var addedText = "(Added on " + todo.addedDate + ")";
          if (todo.editedDate) {
            addedText +=
              ", (Edited on " +
              formatEditedDateDisplay(new Date(todo.editedDate)) +
              ")";
          }
          cellDesc.innerHTML =
            todo.description +
            '<br><small style="color:gray;">' +
            addedText +
            "</small>";

          var cellTarget = row.insertCell(2);
          cellTarget.innerText = formatDateTimeDisplay(todo.targetDateTime);

          var cellStatus = row.insertCell(3);
          cellStatus.innerText = todo.status.toLowerCase();
          cellStatus.style.textTransform = "capitalize";
          cellStatus.style.textAlign = "center";

          var cellAction = row.insertCell(4);
          var actionBtn = document.createElement("button");
          actionBtn.innerText =
            todo.status === "Pending"
              ? "In Progress"
              : todo.status.startsWith("In progress")
              ? "Completed"
              : "";
          actionBtn.style.cursor = "pointer";

          if (todo.status === "completed") {
            actionBtn.disabled = true;
            actionBtn.style.display = "none";
          }

          var dateTimeInput = document.createElement("input");
          dateTimeInput.type = "text";
          dateTimeInput.className = "status-date-time";
          dateTimeInput.style.display = "none";
          dateTimeInput.placeholder = "Select Date and Time";

          actionBtn.addEventListener("click", function () {
            if (todo.status === "Pending") {
              todo.status = "In progress";
              cellStatus.innerText = "In progress";
              actionBtn.innerText = "Completed";
              dateTimeInput.style.display = "block";
              flatpickr(dateTimeInput, {
                enableTime: true,
                dateFormat: "Y-m-d\\TH:i",
                onClose: function (selectedDates) {
                  if (selectedDates.length > 0) {
                    var selectedDateTime = selectedDates[0];
                    todo.status =
                      "In progress (Started on " +
                      formatEditedDateDisplay(selectedDateTime) +
                      ")";
                    cellStatus.innerText = todo.status;
                    dateTimeInput.style.display = "none";
                    sortTodos();
                    renderTable();
                  }
                },
              });
            } else if (todo.status.startsWith("In progress")) {
              todo.status = "completed";
              dateTimeInput.style.display = "block";
              flatpickr(dateTimeInput, {
                enableTime: true,
                dateFormat: "Y-m-d\\TH:i",
                onClose: function (selectedDates) {
                  if (selectedDates.length > 0) {
                    var selectedDateTime = selectedDates[0];
                    todo.status =
                      "completed (Completed on " +
                      formatEditedDateDisplay(selectedDateTime) +
                      ")";
                    cellStatus.innerText = todo.status;
                    dateTimeInput.style.display = "none";
                    actionBtn.disabled = true;
                    actionBtn.style.display = "none";
                    cellEdit.innerHTML = "";
                    sortTodos();
                    renderTable();
                  }
                },
              });
            }
          });

          cellAction.appendChild(actionBtn);
          cellAction.appendChild(dateTimeInput);

          var cellEdit = row.insertCell(5);
          if (!todo.status.startsWith("completed")) {
            var editBtn = document.createElement("button");
            editBtn.innerText = "Edit";
            editBtn.style.cursor = "pointer";
            editBtn.onclick = function () {
              enterEditMode(todo.id);
            };
            cellEdit.appendChild(editBtn);
          }
        });
      }

      function enterEditMode(id) {
        var todo = todos.find((t) => t.id === id);
        if (!todo) return;
        editingTodoId = id;
        document.getElementById("todoDescription").value = todo.description;
        document.getElementById("targetDateTime").value = todo.targetDateTime;
        document.getElementById("todayDate").value = todo.addedDate;
        document.getElementById("status").value = todo.status;
        document.getElementById("addButton").style.display = "none";
        document.getElementById("updateButton").style.display = "inline";
        document.getElementById("cancelButton").style.display = "inline";
      }

      function cancelEdit() {
        editingTodoId = null;
        resetForm();
        document.getElementById("addButton").style.display = "inline";
        document.getElementById("updateButton").style.display = "none";
        document.getElementById("cancelButton").style.display = "none";
      }

      function updateToDo() {
        if (editingTodoId === null) return;
        var description = document
          .getElementById("todoDescription")
          .value.trim();
        var dateTime = document.getElementById("targetDateTime").value;
        var status = document.getElementById("status").value;
        var addedDate = document.getElementById("todayDate").value;

        if (!description || !dateTime) {
          alert("Please enter all required fields.");
          return;
        }

        var nowISO = new Date().toISOString().slice(0, 16);
        if (dateTime < nowISO) {
          alert("You cannot select a past date and time for updates!");
          return;
        }

        var todo = todos.find((t) => t.id === editingTodoId);
        if (!todo) return;
        todo.description = description;
        todo.targetDateTime = dateTime;
        todo.status = status;
        todo.editedDate = new Date().toISOString();
        sortTodos();
        renderTable();
        cancelEdit();
      }

      function resetForm() {
        document.getElementById("todoForm").reset();
        initializeForm();
      }

      function globalSearch() {
        const keywordInput = document
          .getElementById("globalSearchKeyword")
          .value.toLowerCase()
          .trim();
        const startDateInput = document.getElementById("globalStartDate").value;
        const endDateInput = document.getElementById("globalEndDate").value;
        const tbody = document
          .getElementById("todoTable")
          .getElementsByTagName("tbody")[0];
        const rows = tbody.getElementsByTagName("tr");

        for (let row of rows) {
          const cells = row.getElementsByTagName("td");
          const idText = cells[0].innerText.toLowerCase();
          const descText = cells[1].innerText.toLowerCase();
          const statusText = cells[3].innerText.toLowerCase();
          const todoId = parseInt(cells[0].innerText);
          const todo = todos.find((t) => t.id === todoId);
          const todoDateTime = todo ? todo.targetDateTime : "";

          let matchKeyword = true;
          if (keywordInput) {
            matchKeyword =
              idText.includes(keywordInput) ||
              descText.includes(keywordInput) ||
              statusText.includes(keywordInput);
          }

          let matchDateTime = true;
          if (startDateInput || endDateInput) {
            const todoDate = new Date(todoDateTime);
            const startDate = startDateInput ? new Date(startDateInput) : null;
            const endDate = endDateInput ? new Date(endDateInput) : null;

            if (startDate && endDate) {
              matchDateTime = todoDate >= startDate && todoDate <= endDate;
            } else if (startDate) {
              matchDateTime = todoDate >= startDate;
            } else if (endDate) {
              matchDateTime = todoDate <= endDate;
            }
          }

          row.style.display = matchKeyword && matchDateTime ? "" : "none";
        }
      }

      function resetGlobalFilters() {
        document.getElementById("globalSearchKeyword").value = "";
        document.getElementById("globalStartDate").value = "";
        document.getElementById("globalEndDate").value = "";
        globalSearch();
      }
    </script>
    <script>
      flatpickr("#targetDateTime", {
        enableTime: true,
        dateFormat: "Y-m-d\\TH:i",
      });
      flatpickr("#globalStartDate", {
        enableTime: true,
        dateFormat: "Y-m-d\\TH:i",
      });
      flatpickr("#globalEndDate", {
        enableTime: true,
        dateFormat: "Y-m-d\\TH:i",
      });
    </script>
  </body>
</html>
