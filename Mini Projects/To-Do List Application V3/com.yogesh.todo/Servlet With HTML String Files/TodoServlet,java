package com.yogesh.todo;

import jakarta.servlet.ServletException;
import jakarta.servlet.annotation.WebServlet;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
import java.io.IOException;
import java.time.LocalDateTime;
import java.util.List;
import com.yogesh.dao.*;


@WebServlet("/TodoServlet")
public class TodoServlet extends HttpServlet {
    private static final long serialVersionUID = 1L;
    private TodoDAO todoDAO;

    String th = "<!DOCTYPE html>\n"
            + "<html>\n"
            + "  <head>\n"
            + "    <title>To Do List Application</title>\n"
            + "    <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css\" />\n"
            + "    <style>\n"
            + "      body{font-family:Arial,sans-serif}\n"
            + "      table{margin:20px auto;border-collapse:collapse;width:90%}\n"
            + "      th,td{border:1px solid #000;padding:8px;text-align:center}\n"
            + "      h1,h2{text-align:center}\n"
            + "      .disabled-btn{background:#ccc;cursor:not-allowed}\n"
            + "      input[type=submit]{padding:5px 15px}\n"
            + "      input[readonly]{background:#f5f5f5}\n"
            + "      .user-info{text-align:right;margin:10px 20px}\n"
            + "      .logout-btn{padding:5px 10px;background:#f44336;color:#fff;border:none;border-radius:3px}\n"
            + "      #toast{visibility:hidden;min-width:250px;background:#333;color:#fff;text-align:center;border-radius:5px;padding:16px;position:fixed;z-index:1;left:50%;bottom:30px;transform:translateX(-50%);font-size:17px}\n"
            + "      #toast.show{visibility:visible;animation:fadein .5s,fadeout .5s 2.5s}\n"
            + "      #toast.success{background:#4CAF50}\n"
            + "      #toast.error{background:#f44336}\n"
            + "      @keyframes fadein{from{bottom:0;opacity:0}to{bottom:30px;opacity:1}}\n"
            + "      @keyframes fadeout{from{bottom:30px;opacity:1}to{bottom:0;opacity:0}}\n"
            + "    </style>\n"
            + "  </head>\n"
            + "  <body>\n"
            + "    <div class=\"user-info\">\n"
            + "      Welcome, <span id=\"username\">%USERNAME%</span>!\n"
            + "      <button class=\"logout-btn\" onclick=\"window.location.href='LogoutServlet'\">Logout</button>\n"
            + "    </div>\n"
            + "    <h1>To Do List</h1>\n"
            + "    <form method=\"post\" action=\"TodoServlet\">\n"
            + "      <table style=\"margin: 0 auto;\">\n"
            + "        <tr>\n"
            + "          <td><label for=\"todayDate\">Today's Date:</label></td>\n"
            + "          <td><input type=\"date\" id=\"todayDate\" name=\"todayDate\" required readonly /></td>\n"
            + "        </tr>\n"
            + "        <tr>\n"
            + "          <td><label for=\"todoTitle\">To Do Title:</label></td>\n"
            + "          <td><input type=\"text\" id=\"todoTitle\" name=\"todoTitle\" required /></td>\n"
            + "        </tr>\n"
            + "        <tr>\n"
            + "          <td><label for=\"todoDescription\">Description:</label></td>\n"
            + "          <td><input type=\"text\" id=\"todoDescription\" name=\"todoDescription\" /></td>\n"
            + "        </tr>\n"
            + "        <tr>\n"
            + "          <td><label for=\"targetDateTime\">Target Date & Time:</label></td>\n"
            + "          <td><input type=\"text\" id=\"targetDateTime\" placeholder=\"Select target Date and time\" name=\"targetDateTime\" required /></td>\n"
            + "        </tr>\n"
            + "        <tr>\n"
            + "          <td><label for=\"todostatus\">Status:</label></td>\n"
            + "          <td><input type=\"text\" id=\"todoStatus\" value=\"Pending\" name=\"todoStatus\" readonly /></td>\n"
            + "        </tr>\n"
            + "        <tr>\n"
            + "          <td colspan=\"2\" align=\"center\"><input type=\"submit\" value=\"Add To Do\" /></td>\n"
            + "        </tr>\n"
            + "      </table>\n"
            + "    </form>\n"
            + "    <h2>To Do List</h2>\n"
            + "    <div id=\"toast\"></div>\n"
            + "    <table border=\"1\" id=\"todoTable\">\n"
            + "      <thead>\n"
            + "        <tr>\n"
            + "          <th>Todo ID</th>\n"
            + "          <th>ToDo Title</th>\n"
            + "          <th>ToDo Description</th>\n"
            + "          <th>Target Date & Time</th>\n"
            + "          <th>Current Status</th>\n"
            + "          <th>Change Status</th>\n"
            + "          <th>Delete</th>\n"
            + "        </tr>\n"
            + "      </thead>\n"
            + "      <tbody>%TODO_ROWS%</tbody>\n"
            + "    </table>\n"
            + "    <script src=\"https://cdn.jsdelivr.net/npm/flatpickr\"></script>\n"
            + "    <script>\n"
            + "      document.addEventListener('DOMContentLoaded', function() {\n"
            + "        var today = new Date();\n"
            + "        var yyyy = today.getFullYear();\n"
            + "        var mm = String(today.getMonth() + 1).padStart(2, '0');\n"
            + "        var dd = String(today.getDate()).padStart(2, '0');\n"
            + "        var formattedDate = yyyy + '-' + mm + '-' + dd;\n"
            + "        document.getElementById('todayDate').value = formattedDate;\n"
            + "        flatpickr(\"#targetDateTime\", { enableTime: true, dateFormat: \"Y-m-d H:i\" });\n"
            + "      });\n"
            + "\n"
            + "      function showToast(message, isError = false) {\n"
            + "        var toast = document.getElementById('toast');\n"
            + "        toast.innerText = message;\n"
            + "        toast.className = isError ? 'show error' : 'show success';\n"
            + "        setTimeout(function(){ toast.className = toast.className.replace('show', ''); }, 3000);\n"
            + "      }\n"
            + "\n"
            + "      function changeStatus(todoId, currentStatus) {\n"
            + "        var newStatus;\n"
            + "        if (currentStatus === 'Pending') newStatus = 'In Progress';\n"
            + "        else if (currentStatus === 'In Progress') newStatus = 'Completed';\n"
            + "        else return;\n"
            + "\n"
            + "        fetch('TodoServlet?action=changeStatus&todoId=' + todoId + '&newStatus=' + newStatus)\n"
            + "          .then(response => response.text())\n"
            + "          .then(data => {\n"
            + "            showToast(data);\n"
            + "            let statusCell = document.getElementById('status-' + todoId);\n"
            + "            if (statusCell) statusCell.innerText = newStatus;\n"
            + "            let btn = document.getElementById('btn-' + todoId);\n"
            + "            if (btn) {\n"
            + "              if (newStatus === 'Completed') {\n"
            + "                btn.innerText = 'Change Status';\n"
            + "                btn.disabled = true;\n"
            + "                btn.classList.add('disabled-btn');\n"
            + "              } else {\n"
            + "                btn.setAttribute('onclick', \"changeStatus(\" + todoId + \", '\" + newStatus + \"')\");\n"
            + "              }\n"
            + "            }\n"
            + "          })\n"
            + "          .catch(error => {\n"
            + "            console.error('Error:', error);\n"
            + "            showToast('Error updating status', true);\n"
            + "          });\n"
            + "      }\n"
            + "\n"
            + "      function deleteTodo(todoId) {\n"
            + "        if (confirm('Are you sure you want to delete this task?')) {\n"
            + "          fetch('TodoServlet?action=deleteTodo&todoId=' + todoId)\n"
            + "            .then(response => response.text())\n"
            + "            .then(data => {\n"
            + "              showToast(data);\n"
            + "              setTimeout(function() { location.reload(); }, 1000);\n"
            + "            })\n"
            + "            .catch(error => {\n"
            + "              console.error('Error:', error);\n"
            + "              showToast('Error deleting task', true);\n"
            + "            });\n"
            + "        }\n"
            + "      }\n"
            + "    </script>\n"
            + "  </body>\n"
            + "</html>";

    public TodoServlet() {
        super();
        this.todoDAO = new TodoDAO();
    }

    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // Check if user is logged in
        HttpSession session = request.getSession(false);
        if (session == null || session.getAttribute("user") == null) {
            response.sendRedirect(request.getContextPath() + "/login.html");
            return;
        }

        String action = request.getParameter("action");
        if ("changeStatus".equals(action)) {
            handleStatusChange(request, response);
            return;
        } else if ("deleteTodo".equals(action)) {
            handleDeleteTodo(request, response);
            return;
        }

        response.setContentType("text/html");

        // Check for success message in session
        String successMessage = (String) request.getSession().getAttribute("successMessage");
        String errorMessage = (String) request.getSession().getAttribute("errorMessage");

        // Get current user
        UserItem user = (UserItem) session.getAttribute("user");
        String html = generateTodoHTML(user);

        if (successMessage != null) {
            html = html.replace("</body>", "<script>showToast('" + successMessage + "');</script></body>");
            request.getSession().removeAttribute("successMessage");
        }

        if (errorMessage != null) {
            html = html.replace("</body>", "<script>showToast('" + errorMessage + "', true);</script></body>");
            request.getSession().removeAttribute("errorMessage");
        }

        response.getWriter().append(html);
    }

    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // Check if user is logged in
        HttpSession session = request.getSession(false);
        if (session == null || session.getAttribute("user") == null) {
            response.sendRedirect(request.getContextPath() + "/login.html");
            return;
        }

        try {
        	UserItem user = (UserItem) session.getAttribute("user");

            TodoItem newTodo = new TodoItem();
            newTodo.setTodoTitle(request.getParameter("todoTitle"));
            newTodo.setTodoDesc(request.getParameter("todoDescription"));
            newTodo.setTargetDatetime(LocalDateTime.parse(request.getParameter("targetDateTime").replace(" ", "T")));
            newTodo.setTodoStatusCode("P");
            newTodo.setUserId(user.getUserId());
            newTodo.setCreatedBy(user.getUsername());

            todoDAO.addTodo(newTodo);

            // Store success message in session
            request.getSession().setAttribute("successMessage", "Task submitted successfully!");

            // Redirect to GET request to prevent form resubmission
            response.sendRedirect(request.getContextPath() + "/TodoServlet");
        } catch (Exception e) {
            // Store error message in session
            request.getSession().setAttribute("errorMessage", "Error: " + e.getMessage());
            // Redirect to GET request
            response.sendRedirect(request.getContextPath() + "/TodoServlet");
            e.printStackTrace();
        }
    }

    private void handleStatusChange(HttpServletRequest request, HttpServletResponse response) throws IOException {
        // Check if user is logged in
        HttpSession session = request.getSession(false);
        if (session == null || session.getAttribute("user") == null) {
            response.getWriter().write("You must be logged in to change status");
            return;
        }

        try {
            int todoId = Integer.parseInt(request.getParameter("todoId"));
            String newStatus = request.getParameter("newStatus");
            UserItem user = (UserItem) session.getAttribute("user");

            TodoItem todo = todoDAO.getTodoById(todoId, user.getUserId());
            if (todo != null) {
                String statusCode = "P";
                if ("In Progress".equals(newStatus)) statusCode = "I";
                else if ("Completed".equals(newStatus)) statusCode = "C";
                todo.setTodoStatusCode(statusCode);
                todo.setModifiedBy(user.getUsername());
                todoDAO.updateTodo(todo);
                response.getWriter().write("Status updated to " + newStatus + " successfully!");
            } else {
                response.getWriter().write("Todo item not found or you don't have permission!");
            }
        } catch (Exception e) {
            response.getWriter().write("Error: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private void handleDeleteTodo(HttpServletRequest request, HttpServletResponse response) throws IOException {
        // Check if user is logged in
        HttpSession session = request.getSession(false);
        if (session == null || session.getAttribute("user") == null) {
            response.getWriter().write("You must be logged in to delete tasks");
            return;
        }

        try {
            int todoId = Integer.parseInt(request.getParameter("todoId"));
            UserItem user = (UserItem) session.getAttribute("user");

            todoDAO.deleteTodo(todoId, user.getUserId());
            response.getWriter().write("Task deleted successfully!");
        } catch (Exception e) {
            response.getWriter().write("Error: " + e.getMessage());
            e.printStackTrace();
        }
    }

    private String generateTodoHTML(UserItem user) {
        StringBuilder todoRows = new StringBuilder();
        try {
            // Get only todos for the current user
            List<TodoItem> todos = todoDAO.getAllTodos(user.getUserId());
            for (TodoItem todo : todos) {
                todoRows.append("<tr>");
                todoRows.append("<td>").append(todo.getTodoId()).append("</td>");
                todoRows.append("<td>").append(todo.getTodoTitle() != null ? todo.getTodoTitle() : "").append("</td>");
                todoRows.append("<td>").append(todo.getTodoDesc() != null ? todo.getTodoDesc() : "").append("</td>");
                todoRows.append("<td>").append(todo.getTargetDatetime()).append("</td>");
                String status = getStatusName(todo.getTodoStatusCode());
                todoRows.append("<td id='status-").append(todo.getTodoId()).append("'>").append(status).append("</td>");

                // Change Status button
                if (status.equals("Completed")) {
                    todoRows.append("<td><button id='btn-").append(todo.getTodoId())
                            .append("' class='disabled-btn' disabled>Change Status</button></td>");
                } else {
                    todoRows.append("<td><button id='btn-").append(todo.getTodoId())
                            .append("' onclick=\"changeStatus(")
                            .append(todo.getTodoId())
                            .append(", '")
                            .append(status)
                            .append("')\">Change Status</button></td>");
                }

                // Delete button
                todoRows.append("<td><button onclick=\"deleteTodo(")
                        .append(todo.getTodoId())
                        .append(")\" style='background-color: #f44336; color: white;'>Delete</button></td>");

                todoRows.append("</tr>");
            }
        } catch (Exception e) {
            e.printStackTrace();
        }

        return th.replace("%USERNAME%", user.getUsername())
                .replace("%TODO_ROWS%", todoRows.toString());
    }

    private String getStatusName(String statusCode) {
        switch (statusCode) {
            case "P": return "Pending";
            case "I": return "In Progress";
            case "C": return "Completed";
            default: return "Unknown";
        }
    }
}
